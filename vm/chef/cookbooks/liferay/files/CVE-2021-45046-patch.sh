# Workaround for CVE-2021-45046 fix, Log4j versions < 2.16.0
# https://github.com/advisories/GHSA-7rjr-3q55-vv33
#
# This script check if there is any LOG4J vulnerable version in the system and remove JndiLookup.class
# from all jar files
#
function version_le() { test "$(echo "$@" | tr " " "\n" | sort -V | head -n 1)" == "$1"; }

VERSION_VULNERABLE='2.16.0'

# Search in /
PATH_SEARCH="/"
echo "Looking for vulnerable LOG4J versions < $VERSION_VULNERABLE"
LOG4J_CORE_PATH=$(find $PATH_SEARCH -name '*.jar' | grep "log4j-core")

if [[ $? == 0 ]]; then
    echo "LOG4J found in $LOG4J_CORE_PATH"
    LOG4J_VERSION_FOUND=$(echo $LOG4J_CORE_PATH | grep -o "[0-9]\+\.[0-9]\+\.[0-9]\+")
    echo "LOG4J version: $LOG4J_VERSION_FOUND"

    if version_le $LOG4J_VERSION_FOUND $VERSION_VULNERABLE; then
        echo "Version vulnerable, fixing"
        echo "Removing JndiLookup.class from all files in classpath"

        for file in $(find $PATH_SEARCH -type f -name "*.jar" -exec sh -c "zipinfo -1 {} | grep JndiLookup.class 2>&1 && echo {}" \; 2>/dev/null | sed '$!N;s/\n/,/')
        do
            JAVA_CLASS=$(echo $file | awk -F ',' '{print $1}')
            JAR_FILE_PATH=$(echo $file | awk -F ',' '{print $2}')
            echo "Removing $JAVA_CLASS class from $JAR_FILE_PATH file"
            zip -q -d $JAR_FILE_PATH $JAVA_CLASS
        done
        echo "Vulnerable files removed"
    else
        echo "Version not vulnerable, nothing to do."
    fi
else
    echo "LOG4J jar files not found"
fi
